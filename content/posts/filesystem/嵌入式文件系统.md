---
title: "嵌入式文件系统"
date: 2020-04-21T14:11:20+08:00
description: ""
draft: false
tags: [文件系统]
categories: [文件系统]
---

嵌入式采用的存储设备一般是flash，由于flash同块设备有很较大的差异，因此并不能在flash设备上采用通用文件系统，比如Fat、Ext等等。现在对flash存储器的文件系统越来越多了，主要可以分成两大类：一类是基于转译层和块的设备文件系统，另一类是基于日志结构的文件系统。

基于转译层的文件系统之所以称为基于转译层，是因为在文件系统和flash设备之间有一个中间层叫转译层。这个转译层可以将 Flash 设备模拟成块设备，以供文件系统控制和使用。而基于日志结构的文件系统又可以分为两大类：一类是通用的flash文件系统，一类是专用的flash文件系统。通用的文件系统可以在nor flash上运行，也可以在nand flash上运行。以 jffs为代表的文件系统就是这样的通用 flash文件系统。另一类专业的flash文件系统指的是专门针对flash的文件系统，以yaffs系列的文件系统为代表[^5]。 具体可以参看下图[^4]：

![](https://gitee.com/chengshuyi/scripts/raw/master/img/20200422073948.png)

本文首先介绍了flash的特性，最后介绍了flash上常用的文件系统，以及对应的数据压缩技术、坏块管理技术、磨损均衡技术和垃圾回收技术。

### flash介绍[^1][^2]

flash存储器，也叫快擦写存储器，和磁盘设备相比，flash存储器在体积、扩展性、耗电等方面都有着显著的优势，因此成为了嵌入式系统首选的存储设备。

flash属于非易失性半导体存储器，其类型目前主要两种：nor flash和nand flash。  nand flash广泛应用在各种存储卡、U盘、SSD、eMMC等等大容量设备中。nor flash 能快速随机读取，允许系统直接从存储器中读取代码执行即芯片内执行技术（eXecute In Place），而无需先将代码下载至RAM中再执行，可以像普通ROM一样执行程序。

flash存储器的擦除次数是有限的，一般是$10^6$次。当某块执行过度的擦除操作后，这一块的存储空间将会变为“只读”状态，不能再写入数据。flash存储器也存在着两个主要缺陷：

* 一是在重写之前必须进行擦除，因为flash存储器划分成很多擦除块（sector-erase），对任何一位数据进行修改必须先擦除整个块（sector）；     
* 二是擦除块的擦除次数有限，当一个块提前达到擦除次数上限时，将导致整个存储器无法使用。

#### nor flash

Intel于1988年首先开发出nor flash存储器技术，这也是最早出现的flash存储器技术，目前主要由供应商Intel与AMD支持，主要应用于擦除和编程操作较少而直接执行代码的场合，尤其是纯代码存储应用的理想选择，如PC的BIOS固件、移 动电话、嵌入式系统中装载启动代码等。其特点如下：

- 又名线性flash存储器；
- 能快速随机读取，允许系统直接从存储器中读取代码执行即芯片内执行技术（eXecute In Place），而无需先将代码下载至RAM中再执行；
- 可以单字节或单字编程，但不能单字节擦除，必须以块为单位或对整片进行擦除操作，重新编程之前需要先擦后写。因执行一个编程擦除操作时间较慢（大约5秒），而块尺寸又较大（64KB-128KB），于是在纯数据存储应用中花费的时间较长。

#### nand flash

自1989年东芝公司开发出nand flash以来，如今主要由三星、富士通及东芝等日韩厂商大力支持，这种结构的存储器适合于数据和文件存储，主要作为SM卡、CF卡、PCMCIA卡、固态盘的存储介质，并正成存储器技术的核心。其特点如下：

- 又名非线性flash存储器；
- 以页（256B-512B）为单位进行读和编程操作，以块(4KB-32KB)为单位进行擦除操作,编程擦除时间短一般每块时间为4ms；
- 实现串行读取，随机读取速度慢且不能按字节随机编程；
- 芯片尺寸小，引脚少，是位成本最低的固态存储器；
- 芯片包含有失效块，其数目最大可达到3-35块（取决于存储器密度），失效块虽不影响有效块的性能，但设计者仍需要在地址映射表中屏蔽它。

#### 对比表格

|    类型    |         nor flash          |                          nand flash                          |
| :--------: | :------------------------: | :----------------------------------------------------------: |
|  存储容量  |      小，一般1MB-32MB      |                      大，一般8MB-512MB                       |
| 擦除块大小 |         64KB-256KB         | 6KB-128KB，每块被分为若干个512Bytes的页面，每页面含有16Bs附加存储区 |
|  读写方式  |   线形时间按字节随机读写   |                  以页面为单位读写，类似磁盘                  |
|  读写速度  |       读取快，写入慢       |                        读取慢，写入快                        |
|  擦除时间  |        慢，2s-5s/块        |                        快，2ms-5ms/块                        |
|  坏块比例  |    低，出厂一般没有坏道    |                      高，出场可能有坏道                      |
|    价格    | 低存储密度，尺寸大，价格高 |                  高存储密度，尺寸小，价格低                  |
|  接口形式  |    接并行总线，内存接口    |                     接串行总线，I/O接口                      |
|    寿命    |          十万次级          |                           百万次级                           |
|   可靠性   |      高，位交换几率低      |  低，位交换几率高，必须采用错误探测/错误更正（EDC/ECC）算法  |
|    XIP     |            可以            |                            不支持                            |
|   易用性   |            容易            |                  复杂，一般需要MTD驱动支持                   |
|  设计目的  |     作为ROM的替代产品      |                             磁盘                             |
|  编程方式  |       允许逐字节编程       |            页面编程，且每个页面的编程次数有限制i             |

### 基于flash的文件系统

flash存储器的擦除次数是有限的，一般是$10^6$次。当某块执行过度的擦除操作后，这一块的存储空间将会变为“只读”状态，不能再写入数据。根据以上特点，为了避免某些块的过度操作，而导致存储卡使用寿命降低，设计专门针对flash存储器的文件系统是必要的。嵌入式文件系统要考虑的特性[^2]：

* 数据压缩：通过压缩算法不仅可以降低数据的容量，而且间接的加速了I/O；
* 坏块管理：坏块通常使用带外区域中的特定标记来标识；
* 磨损均衡：由于flash存储芯片的擦除次数是有限制的，文件系统对存储器使用时必须充分考虑这个特性，因此最好能均匀使用存储芯片的每个扇区，以延长存储器的使用寿命。
* 垃圾回收：

![](https://gitee.com/chengshuyi/scripts/raw/master/img/20200421232912.png)

#### jffs2[^3]

jffs文件系统最早是由瑞典Axis Communications公司基于Linux2.0的内核为嵌入式系统开发的文件系统。jffs2是一个可读写的、压缩的、日志型文件系统，并提供了崩溃掉电安全保护，克服了jffs的一些缺点：使用了基于哈希表的日志节点结构,大大加快了对节点的操作速度；支持数据压缩；提供了“写平衡”支持；支持多种节点类型；提高了对flash存储器的利用率，降低了内存的消耗。它的缺点就是当文件系统己满或接近满时，运行会变慢，这主要是因为垃圾回收的问题。

##### 数据压缩

jffs2提供了jffs所没有的数据压缩技术。数据在存放到flash之前会先被压缩，这个过程是由jffs2自动完成。因
此，在使用jffs2时无需自己对数据进行压缩。各种类型的压缩算法皆可内嵌到系统中去，目前jffs2使用的是zlib算
法。该算法比较适合ASCII文件，若压缩对象是二进制文件，压缩效果并不明显。

##### 坏块管理

暂无

##### 磨损均衡  

jffs并没有采用磨损均衡技术，到了jffs2才使用此技术。磨损均衡技术的引入提高了flash的使用寿命期限。jffs2改变了jfss没有块队列的状态，将flash各个块（block）分成三个队列：脏块队列（dirty_list）、干净块队列（clean_list）以及空闲块队列。脏块是指该块上至少有一个节点被标记为废弃（obsoleted）；干净块是指块上
的数据皆有效。工作流程如下：

1. 当系统的空闲块数小于6时，GC进程会被唤醒；
2. 判断jiffies计数器的值，如果jiffies% 100非零，选中脏块队列。否则，将选中干净块队列。（很显然,如果存在脏块的话，选中后者的概率仅为1%。）
3. 如果选中的是脏块队列，则直接进行擦写操作，最后把它挂接到空闲块队列；
4. 如果选中的是干净块队列，则被选中的干净块中的所有数据要被全部移至其它空闲块中，接着对该块进行擦写操作，最后把它挂接到空闲块队列。

##### 垃圾回收

jffs2的垃圾收集技术的原理：当需要增添新内容时，就在节点链表的末端添加新的节点存储新的内容；若要修改文
件的某部分，jffs2将该部分**标记为废弃**，并在节点**链表末端添加修改后的内容**。jffs2如此不断地在flash上添加新的内容，当flash上的存储空间用完时,系统就回收标记为废弃的空间，该过程就称为垃圾收集。垃圾收集进程(简称GC进程)专门负责该项工作。下面是jffs2 GC进程的工作流程：

1. 当系统的空闲块数小于6时，GC进程会被唤醒；
2. GC进程每次只回收一个空闲块；
3. 如果此时flash上的空闲块数仍小于6，那么GC进程必须再回收一个空闲块，直到总的空闲块数达到6为止。

##### 断电保护

断电保护技术的实现依赖于jffs2的日志式存储结构。当系统遭受不正常断电后重新启动时，jffs2自动将系统恢复到断电前最后一个稳定状态。

#### yaffs2[^7]

##### 数据压缩

暂无

##### 坏块管理

暂无

##### 磨损均衡

yaffs2 并未实现真正的磨损均衡算法，而是通过**顺序写策略和串行块分配策略**将擦除次数尽可能均匀地分布在闪存空间上，测试结果表明其均衡效果较好，但忽略了静态数据和“冷”数据的影响，因此是一种局部的磨损均衡机制，有待进一步的改进。

顺序写策略：

串行块分配策略：

##### 垃圾回收

yaffs2垃圾回收操作一般在向文件写数据（函数 yaffs_wr_data_obj）、更新对象头（函数 yaffs_update_oh）和文件截短操作（函数 yaffs_resize_file）等过程中被调用，由函数yaffs_check_gc视当前闪存空间使用情况决定是否触发垃圾回收操作。YAFFS2 的垃圾回收操作分三步进行：

1. 查找到满足回收条件的目标回收块（由函数yaffs_find_gc_block 函数完成），若未找到，则退出；
2. 遍历块中所有页，若页中存放有效数据，则将数据复制到其它块中的空闲页中，然后删除该页，并修改内存中记录闪存空间使用信息的数据结构（如块信息结构 yaffs_block_info，页位图数组 chunk_bits 等）以体现
   闪存空间使用情况的变化（由函数 yaffs_gc_process_chunk 完成）；
3. 当块中所有 chunk 都被删除后，则擦除该块（由函数 yaffs_block_became_dirty 完成），使其可以被再次写入数据。 

#### ubifs[^4]

ubifs文件系统主要包含ubifs和ubi模块，ubifs模块建立在ubi模块的基础上，ubi模块是建立在mtd模块基础上的。三个模块整体关系如下图[^4]：

![](https://gitee.com/chengshuyi/scripts/raw/master/img/20200421234706.png)

ubifs的设计主要是为了解决jffs2文件系统存在的启动时间长、系统扩展性差、内存消耗量大、损耗均衡处理能力差等问题。jffs2的挂载时间是与闪存大小成线性比的（扫描所有的块），ubifs克服了这一弱点（ubi子模块挂载时间还是与闪存大小成线性比的）。

ubifs同jffs2的三个主要区别：

* jffs2将索引（inode）节点存储在内存上，ubifs将索引节点存储在闪存上 ；
* jffs2运行在MTD设备层之上，ubifs运行在ubi层之上；
* jffs2不支持回写（write-back），而ubifs支持回写技术。 

##### 坏块管理

ubi在两种情况下认为peb（physical erase block）已损耗：

* 写peb失败，此时，ubi把这个peb的数据搬移到其他的peb，然后诊断该peb是否出现为坏块，如果是，标记为坏块；
* 擦除操作出现I/O错误，在这种情况下，直接把peb标记为坏块。

##### 磨损均衡

暂无

##### 垃圾回收

暂无

[^1]: [NAND vs. NOR Flash MemoryTechnology Overview](http://aturing.umcs.maine.edu/~meadow/courses/cos335/Toshiba%20NAND_vs_NOR_Flash_Memory_Technology_Overviewt.pdf)
[^2]: 孙健. 基于Flash存储器的嵌入式文件系统的研究与实现[D]. 西安电子科技大学.
[^3]:李桂良, 刘发贵. JFFS2文件系统的关键技术及其在嵌入式系统的应用[J]. 计算机应用, 2003(07):137-139.
[^4]: 冯子陵. 闪存文件系统UBIFS的分析与优化[D]. 2013.
[^5]: 周林. 通用嵌入式文件系统YAFFS的移植[D].
[^6]: Olivier P , Boukhobza J , Senn E . On benchmarking embedded Linux flash file systems[J]. Acm Sigbed Review, 2012, 9(2):43-47.

[^7]: [优质文章]李恒恒. 基于YAFFS2文件系统的NAND Flash存储管理关键技术研究[D].

